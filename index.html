<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vizualizator Excel în Browser</title>
  <style>
    :root { --bg:#ffffff; --card:#ffffff; --text:#0b1220; --muted:#4b5563; --accent:#2563eb; }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#f5f7fb;color:var(--text)}
    .wrap{max-width:1000px;margin:24px auto;padding:16px}
    .card{background:var(--card);border:1px solid rgba(0,0,0,.08);border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.08);overflow:hidden}
    header{padding:18px 20px;border-bottom:1px solid rgba(0,0,0,.08);display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    header h1{font-size:18px;margin:0;font-weight:600;letter-spacing:.2px}
    .controls{display:flex;gap:10px;align-items:center}
    input[type=file]{display:none}
    .btn{appearance:none;border:1px solid rgba(0,0,0,.12);color:var(--text);background:#ffffff;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn:hover{border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.12)}
    .drop{border:2px dashed rgba(0,0,0,.16);border-radius:14px;margin:16px;display:grid;place-items:center;padding:28px;text-align:center;transition:.2s;background:#ffffff}
    .drop.dragover{border-color:var(--accent);background:rgba(37,99,235,.06)}
    .drop p{margin:0;color:var(--muted)}
    .tabs{display:flex;gap:8px;overflow:auto;padding:10px 12px;border-bottom:1px solid rgba(0,0,0,.08);background:#ffffff}
    .tab{white-space:nowrap;border:1px solid rgba(0,0,0,.12);padding:8px 12px;border-radius:999px;background:#f8fafc;cursor:pointer}
    .tab.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(37,99,235,.18) inset}
    #out{padding:16px;overflow:auto;background:#ffffff}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid rgba(0,0,0,.12);padding:8px;vertical-align:top}
    th{background:#f3f4f6}
    .hint{font-size:13px;color:var(--muted);padding:0 18px 18px}
    /* highlight pentru rezultate căutare */
    .hit{outline:2px solid var(--accent); background:rgba(37,99,235,.12)}$1</style>

  <style>
    /* Dark mode overrides */
    body.dark{ background:#0b1220; color:#e7ecf3; }
    body.dark .drawer, body.dark .topbar, body.dark .card, body.dark .drop, body.dark .tabs, body.dark .out{ background:#121a2b; border-color:rgba(255,255,255,.12); }
    body.dark .nav-link, body.dark .tab, body.dark .icon-btn, body.dark .btn, body.dark .search input{ background:#0f1726; border-color:rgba(255,255,255,.12); color:#e7ecf3; }
    body.dark .tab.active, body.dark .nav-link.active{ box-shadow:0 0 0 2px rgba(77,163,255,.18) inset; border-color:#4da3ff; }
    body.dark th{ background:rgba(255,255,255,.06); }
    body.dark .drop.dragover{ background:rgba(77,163,255,.06); }
    body.dark .hint, body.dark .small{ color:#a9b3c4; }
  </style>

  <script>
    // Elemente UI
    const menuBtn = document.getElementById('menuBtn');
    const drawer = document.getElementById('drawer');
    const homeBtn = document.getElementById('homeBtn');
    const backBtn = document.getElementById('backBtn');
    const searchInput = document.getElementById('searchInput');
    const fileInput = document.getElementById('file');
    const saveBtn = document.getElementById('saveHtml');
    const themeBtn = document.getElementById('themeBtn');

    // Tema Dark/Light
    const THEME_KEY='app-theme';
    function applyTheme(t){ document.body.classList.toggle('dark', t==='dark'); themeBtn.textContent = document.body.classList.contains('dark')?'☀️':'🌙'; }
    const saved = localStorage.getItem(THEME_KEY) || 'light';
    applyTheme(saved);
    themeBtn.addEventListener('click', ()=>{ const next = document.body.classList.contains('dark')?'light':'dark'; localStorage.setItem(THEME_KEY,next); applyTheme(next); });

    // Stare aplicație
    let historyStack = ['home'];
    let currentView = 'home';
    const workbooks = { s1:null, s2:null, s3:null };
    let lastHTML = '';

    // Helper: comută vizualizări
    function showView(id){
      if(currentView !== id){ historyStack.push(id); }
      currentView = id;
      document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('.nav-link').forEach(b=>b.classList.toggle('active', b.dataset.section===id));
      // activează/dezactivează export
      saveBtn.disabled = !document.querySelector(`#${id} .out table`);
      // curăță căutarea
      searchInput.value = '';
    }

    // Meniu lateral
    document.querySelectorAll('.nav-link').forEach(b=>{
      b.addEventListener('click', ()=>{
        const id = b.dataset.section;
        if(id==='home') showView('home'); else showView(id);
        drawer.classList.remove('open');
      })
    })

    // Butoane topbar
    menuBtn.addEventListener('click', ()=>{
      const isMobile = window.matchMedia('(max-width: 900px)').matches;
      if (isMobile) {
        drawer.classList.toggle('open');
      } else {
        document.querySelector('.app').classList.toggle('nav-collapsed');
      }
    });
      } else {
        drawer.classList.toggle('closed');
      }
    });
    homeBtn.addEventListener('click', ()=> showView('home'));
    backBtn.addEventListener('click', ()=>{
      if(historyStack.length>1){
        historyStack.pop();
        const prev = historyStack[historyStack.length-1];
        document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
        document.getElementById(prev).classList.add('active');
        currentView = prev;
        document.querySelectorAll('.nav-link').forEach(b=>b.classList.toggle('active', b.dataset.section===prev));
      }
    });

    // Căutare în tabelul vizibil
    function filterRows(query){
      const container = document.querySelector(`#${currentView} .out`);
      const table = container?.querySelector('table');
      if(!table) return;
      const q = query.trim().toLowerCase();
      // curățăm highlight-ul vechi
      table.querySelectorAll('.hit').forEach(td=>td.classList.remove('hit'));
      // dacă e gol, afișăm toate rândurile și ieșim
      if(q===''){ Array.from(table.tBodies).forEach(tb=>Array.from(tb.rows).forEach(tr=>tr.style.display='')); return; }
      let firstHitRow = null;
      Array.from(table.tBodies).forEach(tb=>{
        Array.from(tb.rows).forEach(tr=>{
          let rowHit = false;
          Array.from(tr.cells).forEach(td=>{
            const t = (td.textContent||'').toLowerCase();
            if(t.includes(q)){ rowHit = true; td.classList.add('hit'); }
          });
          tr.style.display = rowHit ? '' : 'none';
          if(rowHit && !firstHitRow) firstHitRow = tr;
        });
      });
      // du-te la primul rezultat
      if(firstHitRow){ firstHitRow.scrollIntoView({behavior:'smooth', block:'center'}); }
    } .out`);
      const table = container?.querySelector('table');
      if(!table) return;
      const q = query.trim().toLowerCase();
      Array.from(table.tBodies).forEach(tb=>{
        Array.from(tb.rows).forEach(tr=>{
          const match = q==='' || Array.from(tr.cells).some(td=> (td.textContent||'').toLowerCase().includes(q));
          tr.style.display = match ? '' : 'none';
        });
      });
    }
    searchInput.addEventListener('input', (e)=> filterRows(e.target.value));

    // SheetJS render per secțiune
    function renderWorkbook(section, wb){
      const tabs = document.getElementById(`tabs-${section}`);
      const out = document.getElementById(`out-${section}`);
      tabs.innerHTML = '';
      tabs.hidden = false;
      const first = wb.SheetNames[0];
      wb.SheetNames.forEach((name, idx) => {
        const b = document.createElement('button');
        b.className = 'tab' + (idx===0?' active':'');
        b.textContent = name;
        b.onclick = () => { tabs.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); b.classList.add('active'); showSheet(section, name); };
        tabs.appendChild(b);
      });
      showSheet(section, first);
    }

    function showSheet(section, name){
      const out = document.getElementById(`out-${section}`);
      const html = XLSX.utils.sheet_to_html(workbooks[section].Sheets[name], { id: `excel-${section}`, editable:false });
      out.innerHTML = html;
      if(currentView===section){ lastHTML = html; saveBtn.disabled = false; }
      const table = out.querySelector('table');
      if(table){ table.style.display='block'; table.style.overflow='auto'; }
      // re-aplică filtrul dacă există text în căutare
      if(currentView===section && searchInput.value) filterRows(searchInput.value);
    }

    function parseFileFor(section, file){
      const reader = new FileReader();
      reader.onload = (e)=>{
        const data = e.target.result;
        workbooks[section] = XLSX.read(data, { type: 'array' });
        renderWorkbook(section, workbooks[section]);
        showView(section); // sari direct la secțiune după upload
      };
      reader.readAsArrayBuffer(file);
    }

    // Upload global — salvează în secțiunea activă (s1/s2/s3), altfel trimite către s1
    fileInput.addEventListener('change', (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      const target = ['s1','s2','s3'].includes(currentView) ? currentView : 's1';
      parseFileFor(target, f);
      e.target.value = '';
    });

    // Drag & drop per secțiune
    ['s1','s2','s3'].forEach(section=>{
      const drop = document.getElementById(`drop-${section}`);
      ['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,(e)=>{e.preventDefault();drop.classList.add('dragover');}));
      ['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,(e)=>{e.preventDefault();drop.classList.remove('dragover');}));
      drop.addEventListener('drop',(e)=>{ const f=e.dataTransfer.files?.[0]; if(f) parseFileFor(section,f); });
    });

    // Export HTML static al tabelului vizibil
    saveBtn.addEventListener('click', ()=>{
      const htmlDoc = `<!doctype html><html lang=\"ro\"><head><meta charset=\"utf-8\"/><meta name=\"viewport\" content=\"width=device-width,initial-scale=1\"/><title>Tabel exportat</title><style>table{width:100%;border-collapse:collapse}th,td{border:1px solid #ddd;padding:8px}th{background:#f3f4f6}</style></head><body>${lastHTML}</body></html>`;
      const blob = new Blob([htmlDoc], { type: 'text/html;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'tabel.html'; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 2000);
    });
  </script>
</body>
</html>
